name: Haskell CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: write

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: haskell-actions/setup@v2 
      with:
        ghc-version: '9.4.8'
      #   cabal-version: '3.2'

    - name: Cache ~/.cabal/packages, ~/.cabal/store and dist-newstyle
      uses: actions/cache@v4
      with:
        path: |
          ~/.cabal/packages
          ~/.cabal/store
          dist-newstyle
        key: ${{ runner.os }}-${{ matrix.ghc }}-${{ hashFiles('**/*.cabal', '**/cabal.project', '**/cabal.project.freeze') }}
        restore-keys: ${{ runner.os }}-${{ matrix.ghc }}-
            
    - name: Install dependencies
        # If we had an exact cache hit, the dependencies will be up to date.
      if: steps.cache.outputs.cache-hit != 'true'
      run: cabal build all --only-dependencies
        
    - name: Build
      run: cabal build --enable-tests --enable-benchmarks all
    - name:  Build Docs folder
      run: cabal exec site rebuild 

    - name: Setup Pages
      uses: actions/configure-pages@v5.0.0

    - name: Upload Artifacts
      uses: actions/upload-pages-artifact@v3.0.1
      with: 
        path: 'docs/'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
  
